<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <title>Leaflet</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
    integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin="" />
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
    }

    body {
      padding: 0;
      margin: 0;
    }

    #map_canvas {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body onload="initialize()">
  <div id="map_canvas"></div>
  <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
    integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
    crossorigin=""></script>
  <script>
    /*---------------------------------------------------
    * Hochschule für Technik Stuttgart
    * Fachbereich Vermessung, Informatik und Mathematik
    * Schellingstr. 24
    * D-70174 Stuttgart
    *
    * Volker Coors, Athnasios Koukofikis
    * 7.11.2018
    *
    * GeoVisualisierung
    *
    * ------------------------------------------------*/
    const geocodeUrl = 'https://nominatim.openstreetmap.org/search?q=';
    const geocodeParams = '&format=json&limit=1';

    function csvJSON(csv){
      var lines = csv.replace(/\n/g, '');
      lines = lines.split("\r");

      var result = [];

      var headers=lines[0].split(";");

      for(var i=1;i<lines.length;i++){

        var obj = {};
        var currentline=lines[i].split(";");
        for(var j=0;j<headers.length;j++){
            obj[headers[j]] = currentline[j];
          }

          result.push(obj);

        }

        return result; //JavaScript object
        //return JSON.stringify(result); //JSON
      }

    function geocode(address){
      const geocodeUrl = 'https://nominatim.openstreetmap.org/search?q=';
      const geocodeParams = '&format=json&limit=1';

      var encoded = encodeURI([geocodeUrl, address, geocodeParams].join(''));
      return $.getJSON(encoded);
    }
    // function geocode(address) {
    //     var encoded = encodeURI([geocodeUrl, address, geocodeParams].join(''));
    //     var xhr = new XMLHttpRequest();
    //     xhr.open("GET", encoded, true);
    //     xhr.responseType = 'json';
    //     xhr.onload = function () {
    //       if (xhr.response.length == 0) {
    //         alert("No place found");
    //         return;
    //       }
    //       return xhr.response[0];
    //     };
    //     xhr.onerror = function () {
    //       console.error(xhr.statusText);
    //     };
    //     xhr.send();
    //   }

    let map;
    /**
    * Die Methode initialize wird beim Laden der Webseite aufgerufen
    * durch HTML <body onload="initialize()">, siehe unten.
    */
    function initialize() {
      /**
        * zoom level: 0 - 18
        *
        * 0 - Weltkarte
        *  ...
        * 18 - Einzelgebäue
        *
        * siehe https://leafletjs.com/examples/zoom-levels/
      *
        * setView:
        * der erste Paramter definiert den Mittelpunkt der Karte in
      * Längen- und Breitengrad (Koordinatensystem WGS 84)
        *
      * Stuttgart - [48.81, 9.16]
        * Sidney - [-33.51, 151.12]
        *
      */
      map = L.map('map_canvas').setView([48.75, 9.21], 5);
      /**
      * Die Karte basiert auf OpenStreetmap Daten und wird als gekachelte
      * Rasterkarte bereitgestellt.
      * Hinweis: In den Beispielen des Leaflet Quickstart Tutorials werden Karten von
      * MapBox genutzt. Diese sind auch mit einem
      * Geschäftsmodell verbunden, siehe https://www.mapbox.com/pricing/
      * https://leafletjs.com/examples/quick-start/
      *
      */
      let osm = new L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
        minZoom: 2,
        maxZoom: 18
      });
      map.addLayer(osm);

      var ba_icon = L.icon({
        iconUrl: 'images/ba.png',
        iconSize: [20, 32], // size of the icon
        iconAnchor: [0, 32], // point of the icon which will correspond to marker's location
        popupAnchor: [0, -32] // point from which the popup should open relative to the iconAnchor
      });
      var bps_icon = L.icon({
        iconUrl: 'images/bps.png',
        iconSize: [20, 32], // size of the icon
        iconAnchor: [0, 32], // point of the icon which will correspond to marker's location
        popupAnchor: [0, -32] // point from which the popup should open relative to the iconAnchor
      });

      // adress_data = $(document).ready(function() {
      //   $.ajax({
      //     type: "GET",
      //     url: "adressen.csv",
      //     dataType: "text",
      //     success: function(data) {csvJSON(data);}
      //   });
      // });

      fetch('adressen.csv')
        .then(response => response.text())
        .then((data) => {
          adress_data = csvJSON(data);

          for (let datapoint of adress_data){
        	  let icon_url = "";
       		  if (datapoint['Stelle'] == "BPS"){
       			  icon_url = "images/bps.png";
       		  } else if (datapoint['Stelle'] == "BT") {
       			  icon_url = "images/ba.png";
       		  }
            console.log(icon_url);
       	      let current_icon = L.icon({
       	        iconUrl: icon_url,
       	        iconSize: [20, 32], // size of the icon
       	        iconAnchor: [0, 32], // point of the icon which will correspond to marker's location
       	        popupAnchor: [0, -32] // point from which the popup should open relative to the iconAnchor
       	      });

        	  let coordinates = geocode(datapoint['Kontaktadresse']);
            coordinates.then( function(value) {
              if(jQuery.isEmptyObject(value)){
					           return;
				      }
      				let coordinates = value[0];
      				lat = coordinates.lat;
      				lon = coordinates.lon
              var marker = L.marker([lat, lon],
              {
                icon : current_icon,
                title : datapoint["Unternehmen"]
              }).addTo(map).bindPopup("<b>" + datapoint["Unternehmen"] + ": " + datapoint["Themen"] + "</b>").openPopup();
            });

          }
      })

    }
  </script>
  <script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous">
  </script>
</body>

</html>
